# Phase 8 --- SOAR Email Playbook (Azure Sentinel + Logic Apps)

> **Context**: Incidents are already being generated by the brute-force
> analytics rule. No Entra ID logs due to tenant permissions.\
> **Outcome**: Email notification fires for every **new Sentinel
> incident** created by the brute-force rule. RBAC is correct.
> Automation rule is attached. Test + evidence captured.

------------------------------------------------------------------------

## Prereqs (one-time)

-   Azure Sentinel workspace exists and is creating incidents from the
    brute-force analytics rule.
-   You can send mail from either:
    -   **Office 365 Outlook** (preferred) using your account or a
        shared mailbox; or
    -   **SMTP** (fallback).
-   You have rights in the subscription to create Logic Apps and assign
    RBAC at the **Sentinel workspace** scope.

------------------------------------------------------------------------

## 1) Create the playbook (Logic App -- Consumption)

**Azure Portal** → search **Logic Apps** → **Add**\
- **Resource Group**: `rg-sentinel-automation` (or your RG)\
- **Logic App name**: `pbk-EmailOnNewIncident`\
- **Region**: same region as the Sentinel workspace\
- **Plan**: Consumption\
- **Review + create** → **Create**

Open the Logic App → **Designer** → **Blank Logic App**\
1. **Trigger**: search `Microsoft Sentinel` → select **Microsoft
Sentinel incident**.\
2. **Action 1 (comment)**: **Add comment to incident** → Comment:
`Playbook pbk-EmailOnNewIncident kicked off.`\
3. **Action 2 (email)**:\
- Add action **Send an email (V2)** (Office 365 Outlook).\
- **To**: your test email or distribution list\
- **Subject**:
`New Sentinel Incident: @{triggerBody()?['properties']?['title']}`\
- **Body (HTML)**: includes Incident Title, Severity, Status, Workspace,
Incident URL, ARM ID.

------------------------------------------------------------------------

## 2) Enable and prepare the playbook identity (RBAC)

-   Enabled **System Assigned Identity** on the playbook.\
-   Granted **Microsoft Sentinel Responder** at the workspace level.\
-   Verified ability to run playbook from incidents (Playbook Operator
    on RG).

**Obstacle:**\
- Initially tried "classic automated response" → saw Microsoft
deprecation notice.\
- **Fix:** Migrated to **Automation rules** to attach playbook.

------------------------------------------------------------------------

## 3) Attach the playbook using an **Automation rule**

**Microsoft Sentinel** → **Automation** → **Create automation rule**

-   **Name**: `AR - Email on new incident (Brute Force)`\
-   **Trigger**: `When incident is created`\
-   **Condition**: Analytics rule name contains the brute-force rule
    name\
-   **Action**: Run playbook → `pbk-EmailOnNewIncident`

**Obstacle:**\
- First automation rule didn't trigger because the query used
`SecurityEvent | take 1` → no data when lab VMs (DC01/Client01) were
off.\
- **Fix:** Switched query to `print test="ForceTestRow"`, ensuring
incidents always generate for testing.

------------------------------------------------------------------------

## 4) Test & Evidence

### Manual Test

-   Ran playbook manually on a brute-force incident.\
-   Verified Logic App **Run History → Succeeded**.\
-   Email delivered successfully.

### Automation Test

-   Triggered incident via `print test="ForceTestRow"`.\
-   New incident created.\
-   Automation rule ran playbook automatically.\
-   Email notification received with proper HTML formatting.

**Obstacles faced and fixes:**\
- **Email body showed raw `<p>` tags**: fixed by editing code view and
forcing `"IsHtml": true`.\
- **Indentation issues in Logic App code view**: discovered that Azure
portal editor doesn't handle Tab. Used spaces / external editor to keep
JSON readable.\
- **Delay in incident firing**: expected; resolved by switching to
`print` query for guaranteed test signals.

------------------------------------------------------------------------

## 5) Results

-   **Every new Sentinel incident** from brute-force rule →
    auto-triggers playbook.\
-   **Email notifications** contain clean HTML with clickable Sentinel
    Incident URL.\
-   **Comment** added to incident confirming playbook execution.\
-   Evidence captured:
    -   Logic App Designer view\
    -   IAM RBAC assignment\
    -   Automation rule creation\
    -   Logic App run history (Succeeded)\
    -   Email inbox screenshot with properly formatted notification

------------------------------------------------------------------------

## Screenshots to Capture (filenames)

1.  `LogicApp-Create-Blank-Playbook.png`\
2.  `LogicApp-Enable-Managed-Identity.png`\
3.  `IAM-RoleAssignment-SentinelResponder.png`\
4.  `LogicApp-Designer-IncidentTrigger.png`\
5.  `LogicApp-Designer-OutlookV2.png`\
6.  `Sentinel-Automation-CreateRule-IncidentCreated.png`\
7.  `Sentinel-Automation-Condition-AnalyticsRuleName.png`\
8.  `Sentinel-Automation-Action-RunPlaybook.png`\
9.  `Incidents-RunPlaybook-Manual.png`\
10. `LogicApp-RunHistory-Succeeded.png`\
11. `Email-Inbox-NewIncident.png`

------------------------------------------------------------------------

## Evidence

Store screenshots under:\
`/evidence/phase-08/`

------------------------------------------------------------------------

## Troubleshooting Quick Notes

-   **Playbook not running**: Ensure trigger = Sentinel incident,
    automation rule scope = correct Analytics rule name.\
-   **Manual run disabled**: Assign yourself
    `Microsoft Sentinel Playbook Operator` on RG.\
-   **403 errors**: Playbook identity needs Sentinel Responder at
    workspace.\
-   **Email plain text**: Add `"IsHtml": true` or
    `"BodyContentType": "HTML"` in code view.\
-   **No incidents**: Use `print test="ForceTestRow"` for guaranteed
    testing when lab VMs are off.
