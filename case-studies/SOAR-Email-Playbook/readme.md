# Phase 8 — SOAR Email Playbook (Azure Sentinel + Logic Apps)

> **Context**: Incidents are already being generated by the brute-force analytics rule. No Entra ID logs due to tenant permissions.  
> **Outcome**: Email notification fires for every **new Sentinel incident** created by the brute-force rule. RBAC is correct. Automation rule is attached. Test + evidence captured.

---

## Prereqs (one-time)
- Azure Sentinel workspace exists and is creating incidents from the brute-force analytics rule.
- You can send mail from either:
  - **Office 365 Outlook** (preferred) using your account or a shared mailbox; or
  - **SMTP** (fallback).
- You have rights in the subscription to create Logic Apps and assign RBAC at the **Sentinel workspace** scope.

---

## 1) Create the playbook (Logic App – Consumption)

**Azure Portal** → search **Logic Apps** → **Add**  
- **Resource Group**: `rg-sentinel-automation` (or your RG)  
- **Logic App name**: `pbk-EmailOnNewIncident`  
- **Region**: same region as the Sentinel workspace  
- **Plan**: Consumption  
- **Review + create** → **Create**

Open the Logic App → **Designer** → **Blank Logic App**  
1. **Trigger**: search `Microsoft Sentinel` → select **Microsoft Sentinel incident** (a.k.a. *When a response to a Microsoft Sentinel incident is triggered*).  
2. **Action 1 (optional but recommended)**: **Add comment to incident** → Comment: `Playbook pbk-EmailOnNewIncident kicked off.`  
3. **Action 2 (email)**:  
   - If **Office 365 Outlook**:
     - Add action **Send an email (V2)**.  
     - Connect using your account (or connection using a service account).  
     - **To**: your test email or distribution list  
     - **Subject**: `New Sentinel Incident: @{triggerBody()?['properties']?['title']}`  
     - **Body (HTML)** (example):
       ```
       <b>Incident:</b> @{triggerBody()?['properties']?['title']}<br/>
       <b>Severity:</b> @{triggerBody()?['properties']?['severity']}<br/>
       <b>Status:</b> @{triggerBody()?['properties']?['status']}<br/>
       <b>Workspace:</b> @{triggerBody()?['properties']?['workspaceName']}<br/>
       <b>Incident ID:</b> @{triggerBody()?['name']}
       ```
     - (Optional) If using a **shared mailbox**, set the *From (Send as)* or choose the **Send an email from a shared mailbox (V2)** action after the mailbox is delegated to your account.
   - If **SMTP**:
     - Add **SMTP** → **Send Email**  
     - Configure server/port/username/password (org SMTP relay or 3rd-party).

**Save** the Logic App.

---

## 2) Enable and prepare the playbook identity (RBAC)

Open the playbook resource → **Identity** → **System assigned** → **On** → **Save** (note the Object ID).

Go to **Microsoft Sentinel** → your **Workspace** → **Settings** → **Workspace settings** → **Access control (IAM)** → **Add** → **Add role assignment**:
- **Role**: `Microsoft Sentinel Responder` (use `Reader` only if you never write; we write comments → use Responder).
- **Assign access to**: `Logic App`
- **Select**: `pbk-EmailOnNewIncident`
- **Save**

> If you’ll run playbooks manually from the Incidents blade: make sure **your user** has `Microsoft Sentinel Playbook Operator` on the playbook’s **resource group**.

---

## 3) Attach the playbook using an **Automation rule** (incident-level)

**Microsoft Sentinel** → **Configuration** → **Automation** → **Create** → **Automation rule**

- **Name**: `AR - Email on new incident (Brute Force)`
- **Trigger**: `When incident is created`
- **Conditions**  
  - **Analytics rule name** → **Contains** → *exact display name of your brute-force rule*  
    *(Example: `Windows Security Events - Multiple Failed Logons (Brute Force)`)*

- **Actions**  
  - **+ Add action** → **Run playbook** → select `pbk-EmailOnNewIncident`

- **Order**: leave default (or bump higher if you have many rules)  
- **Expiration**: leave **None**  
- **Apply**

> Note: attaching playbooks directly in the analytics rule’s “Automated response (classic)” is deprecated. Use Automation rules as above.

---

## 4) Test it (two ways) and capture evidence

### A) Quick manual run (sanity check)
1. **Sentinel** → **Incidents** → open a recent *brute-force* incident.
2. **Actions** → **Run playbook** → choose `pbk-EmailOnNewIncident` → **Run**.
3. Verify:
   - **Logic App** → **Runs history** shows **Succeeded**.
   - Email lands in the target mailbox.
4. Take screenshots (see list below).

### B) End-to-end automation run (fresh incident)
1. Generate signal to fire the **brute-force** rule (e.g., run your failed-logon simulator).
2. Wait for the new **incident** to appear → the Automation rule triggers the playbook → email arrives.
3. Record **Incident time**, **Run history**, and **email message**.

---

## Screenshots to Capture (filenames)

1. `LogicApp-Create-Blank-Playbook.png` — New Logic App (blank) in Designer  
2. `LogicApp-Enable-Managed-Identity.png` — System-assigned identity **On**  
3. `IAM-RoleAssignment-SentinelResponder.png` — IAM add role assignment → Responder → Assign to Logic App  
4. `LogicApp-Designer-IncidentTrigger.png` — Trigger set to **Microsoft Sentinel incident**  
5. `LogicApp-Designer-OutlookV2.png` — **Send an email (V2)** action with dynamic fields populated  
6. `Sentinel-Automation-CreateRule-IncidentCreated.png` — New Automation rule with **When incident is created**  
7. `Sentinel-Automation-Condition-AnalyticsRuleName.png` — Condition scoping to brute-force rule  
8. `Sentinel-Automation-Action-RunPlaybook.png` — Action = Run playbook → `pbk-EmailOnNewIncident`  
9. `Incidents-RunPlaybook-Manual.png` — Actions → Run playbook on an incident (manual test)  
10. `LogicApp-RunHistory-Succeeded.png` — Run history **Succeeded** with timestamps  
11. `Email-Inbox-NewIncident.png` — Delivered email with incident fields visible

---

## Evidence

> Paste these under your repo’s `/evidence/phase-08/` (or similar).

- **Run History**: `LogicApp-RunHistory-Succeeded.png` (includes Run ID & timestamp)  
- **Mailbox Proof**: `Email-Inbox-NewIncident.png` (headers visible if possible)  
- **Scope Proof**: `Sentinel-Automation-Condition-AnalyticsRuleName.png` (rule targeting)  
- **RBAC Proof**: `IAM-RoleAssignment-SentinelResponder.png` (role → Logic App)  

---

## Troubleshooting (blunt & fast)

- **Playbook didn’t run on new incidents**  
  - Wrong trigger. Must be **Microsoft Sentinel incident**; Automation rule must be **When incident is created** and scoped to the **Analytics rule name**.  
- **Manual run button is disabled**  
  - Your **user** lacks `Microsoft Sentinel Playbook Operator` on the playbook’s RG. Get it and refresh.  
- **403 / “Caller is missing required permissions” inside actions**  
  - The **playbook identity** doesn’t have enough rights. Give it `Microsoft Sentinel Responder` at the workspace.  
- **Email didn’t arrive**  
  - Fix the **Office 365 Outlook** connection (re-auth) or test with **SMTP**. For shared mailboxes, ensure *Send As* or use **Send from shared mailbox (V2)**.  
- **Delay in Automation rule execution**  
  - Expect some lag in certain Defender-integrated flows; be patient or use **manual run** to validate the playbook logic.

---

## What to commit
- `README-Phase08-SOAR-Email-Playbook.md` (this file)
- `/evidence/phase-08/` with the 11 screenshots above
